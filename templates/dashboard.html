<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Automation Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        
        .header { background: #2563eb; color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header .status { font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        
        .card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h3 { color: #374151; margin-bottom: 1rem; font-size: 1.1rem; }
        
        .stat { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb; }
        .stat:last-child { border-bottom: none; }
        .stat-label { color: #6b7280; }
        .stat-value { font-weight: 600; color: #111827; }
        
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .status-online { background: #10b981; }
        .status-offline { background: #ef4444; }
        
        .log-container { max-height: 300px; overflow-y: auto; background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.875rem; }
        .log-entry { margin-bottom: 0.25rem; }
        
        .btn { background: #2563eb; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .schedule-item { background: #f9fafb; padding: 0.75rem; border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid #2563eb; }
        .schedule-time { font-weight: 600; color: #2563eb; font-size: 0.875rem; }
        .schedule-title { color: #374151; margin-top: 0.25rem; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .container { padding: 0 0.5rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Content Automation Dashboard</h1>
        <div class="status">
            <span class="status-indicator status-online"></span>
            <span id="connection-status">Connected</span> â€¢ 
            <span id="last-update">Loading...</span>
        </div>
    </div>
    
    <div class="container">
        <div class="grid">
            <!-- System Status -->
            <div class="card">
                <h3>System Status</h3>
                <div class="stat">
                    <span class="stat-label">System</span>
                    <span class="stat-value" id="system-status">Loading...</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Uptime</span>
                    <span class="stat-value" id="uptime">Loading...</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Last Stream</span>
                    <span class="stat-value" id="last-stream">Loading...</span>
                </div>
            </div>
            
            <!-- Stream Stats -->
            <div class="card">
                <h3>Stream Statistics</h3>
                <div class="stat">
                    <span class="stat-label">Streams Today</span>
                    <span class="stat-value" id="streams-today">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Total Streams</span>
                    <span class="stat-value" id="total-streams">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Processing Queue</span>
                    <span class="stat-value" id="processing-queue">0</span>
                </div>
            </div>
            
            <!-- Upload Stats -->
            <div class="card">
                <h3>Upload Statistics</h3>
                <div class="stat">
                    <span class="stat-label">Uploads Today</span>
                    <span class="stat-value" id="uploads-today">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Pending Uploads</span>
                    <span class="stat-value" id="pending-uploads">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Queue Size</span>
                    <span class="stat-value" id="queue-size">0</span>
                </div>
            </div>
        </div>
        
        <div class="grid" style="margin-top: 2rem;">
            <!-- Publishing Schedule -->
            <div class="card">
                <h3>Publishing Schedule</h3>
                <div id="schedule-container">
                    <div class="schedule-item">
                        <div class="schedule-time">Loading schedule...</div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity Logs -->
            <div class="card">
                <h3>Recent Activity</h3>
                <div class="log-container" id="logs-container">
                    <div class="log-entry">Loading logs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Connection status
        socket.on('connect', () => {
            document.getElementById('connection-status').textContent = 'Connected';
            document.querySelector('.status-indicator').className = 'status-indicator status-online';
        });
        
        socket.on('disconnect', () => {
            document.getElementById('connection-status').textContent = 'Disconnected';
            document.querySelector('.status-indicator').className = 'status-indicator status-offline';
        });
        
        // System updates
        socket.on('system_update', (data) => {
            updateDashboard(data);
        });
        
        // Request initial update
        socket.emit('request_update');
        
        // Update dashboard with new data
        function updateDashboard(data) {
            document.getElementById('last-update').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
            
            if (data.error) {
                console.error('Dashboard error:', data.error);
                return;
            }
            
            // System status
            document.getElementById('system-status').textContent = data.system?.running ? 'Online' : 'Offline';
            document.getElementById('uptime').textContent = data.system?.uptime || 'Unknown';
            
            // Stream stats
            document.getElementById('streams-today').textContent = data.streams?.today || 0;
            document.getElementById('total-streams').textContent = data.streams?.total || 0;
            document.getElementById('processing-queue').textContent = data.processing?.pending_jobs || 0;
            
            // Upload stats
            document.getElementById('uploads-today').textContent = data.uploads?.today || 0;
            document.getElementById('pending-uploads').textContent = data.uploads?.pending || 0;
            document.getElementById('queue-size').textContent = data.uploads?.queue_size || 0;
            
            // Last stream info
            const lastStream = data.streams?.last_stream;
            document.getElementById('last-stream').textContent = lastStream ? 
                new Date(lastStream.created_at).toLocaleString() : 'None today';
        }
        
        // Load schedule
        function loadSchedule() {
            fetch('/api/schedule')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('schedule-container');
                    container.innerHTML = '';
                    
                    if (data.length === 0) {
                        container.innerHTML = '<div class="schedule-item"><div class="schedule-time">No scheduled content</div></div>';
                        return;
                    }
                    
                    data.slice(0, 5).forEach(item => {
                        const scheduleItem = document.createElement('div');
                        scheduleItem.className = 'schedule-item';
                        
                        const time = new Date(item.scheduled_publish_at).toLocaleString();
                        const title = item.youtube_title || item.title || 'Untitled';
                        
                        scheduleItem.innerHTML = `
                            <div class="schedule-time">${time}</div>
                            <div class="schedule-title">${title.substring(0, 50)}${title.length > 50 ? '...' : ''}</div>
                        `;
                        
                        container.appendChild(scheduleItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    document.getElementById('schedule-container').innerHTML = 
                        '<div class="schedule-item"><div class="schedule-time">Error loading schedule</div></div>';
                });
        }
        
        // Load logs
        function loadLogs() {
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('logs-container');
                    container.innerHTML = '';
                    
                    if (!data.logs || data.logs.length === 0) {
                        container.innerHTML = '<div class="log-entry">No recent logs</div>';
                        return;
                    }
                    
                    // Show last 20 log entries
                    data.logs.slice(-20).reverse().forEach(log => {
                        const logEntry = document.createElement('div');
                        logEntry.className = 'log-entry';
                        logEntry.textContent = log.trim();
                        container.appendChild(logEntry);
                    });
                    
                    // Auto-scroll to top of logs
                    container.scrollTop = 0;
                })
                .catch(error => {
                    console.error('Error loading logs:', error);
                    document.getElementById('logs-container').innerHTML = 
                        '<div class="log-entry">Error loading logs</div>';
                });
        }
        
        // Initial data load
        loadSchedule();
        loadLogs();
        
        // Refresh data periodically
        setInterval(() => {
            loadSchedule();
            loadLogs();
        }, 60000); // Every minute
        
        // Request system updates every 30 seconds
        setInterval(() => {
            socket.emit('request_update');
        }, 30000);
    </script>
</body>
</html>